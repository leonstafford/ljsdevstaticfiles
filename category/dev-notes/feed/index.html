<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Dev Notes &#8211; Leon Stafford</title>
	<atom:link href="https://ljs.dev/category/dev-notes/feed/" rel="self" type="application/rss+xml" />
	<link>http://ljs.dev/</link>
	<description></description>
	<lastBuildDate>Mon, 25 Mar 2019 17:06:46 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://www.classicpress.net/?v=4.9.10-cp-1.0.1</generator>
	<item>
		<title>Huawei E3372 USB 3G/4G modem under OpenBSD 6.4</title>
		<link>https://ljs.dev/huawei-e3372-usb-3g-4g-modem-under-openbsd-6-4/</link>
		<pubDate>Thu, 13 Dec 2018 15:54:59 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Dev Notes]]></category>

		<guid isPermaLink="false">https://ljs.dev/?p=458</guid>
		<description><![CDATA[Notes on getting connected to 3G/4G in Thailand on the dtac prepaid SIM obsd# gammu identify Device : /dev/cuaU0 Manufacturer : Huawei Model : E3372 (E3372) Firmware : 22.329.63.00.74 IMEI : 866785033700732 SIM IMSI : 520050314388175 Example smsd.conf loglevel = 7 user = _smsd pidfile = /var/run/smsd/smsd.pid infofile = /var/run/smsd/smsd.info logfile = /var/log/smsd/smsd.log [GSM1] device &#8230; <p class="link-more"><a href="https://ljs.dev/huawei-e3372-usb-3g-4g-modem-under-openbsd-6-4/" class="more-link">Continue reading<span class="screen-reader-text"> "Huawei E3372 USB 3G/4G modem under OpenBSD 6.4"</span></a></p>]]></description>
				<content:encoded><![CDATA[<p>Notes on getting connected to 3G/4G in Thailand on the dtac prepaid SIM</p>
<pre><code>obsd# gammu identify
Device               : /dev/cuaU0
Manufacturer         : Huawei
Model                : E3372 (E3372)
Firmware             : 22.329.63.00.74
IMEI                 : 866785033700732
SIM IMSI             : 520050314388175
</code></pre>
<p>Example <code>smsd.conf</code></p>
<pre><code>loglevel = 7

user = _smsd

pidfile = /var/run/smsd/smsd.pid
infofile = /var/run/smsd/smsd.info

logfile = /var/log/smsd/smsd.log

[GSM1]
device = /dev/cuaU0

init = AT^CURC=0

# For this one I have set incoming=no so it doesn't pull
# the existing messages off the phone.
incoming = no
rtscts = no
baudrate = 115200
eventhandler = /home/leon/smstoolsevents.sh
send_delay = 20
</code></pre>
<p>And a simple script to log events <code>/home/leon/smstoolsevents.sh</code></p>
<pre><code>

#!/bin/ksh

# script to react to events, like receiving an SMS

echo '' &gt;&gt; /home/leon/logsmsevents
echo 'received a message' &gt;&gt; /home/leon/logsmsevents


</code></pre>
<p><code>smsd</code> log with above settings gives the following when <code>smsd</code> is restarted:</p>
<pre><code>2018-12-13 12:24:38,6, GSM1: Modem is registered to a roaming partner network                                                                                                             [79/2614]
2018-12-13 12:24:38,2, smsd: Smsd mainprocess is awaiting the termination of all modem handlers. PID: 830.                                                                                        
2018-12-13 12:24:38,2, GSM1: Modem handler 0 terminated. PID: 61548, was started 18-12-13 12:15:24, up 9 min.                                                                                     
2018-12-13 12:24:38,2, smsd: Smsd mainprocess terminated. PID: 830, was started 18-12-13 12:15:24, up 9 min.                                                                                      
2018-12-13 12:24:38,2, smsd: Smsd v3.1.21 started.
2018-12-13 12:24:38,2, smsd: Running as _smsd:_smsd (590:590).
2018-12-13 12:24:38,7, smsd: Running startup_check (shell): /var/spool/sms/incoming/smsd_script.FZMA0a /tmp/smsd_data.sP5YHd                                                                      
2018-12-13 12:24:38,7, smsd: Done: startup_check (shell), execution time 0 sec., status: 0 (0)
2018-12-13 12:24:38,4, smsd: File mode creation mask: 022 (0644, rw-r--r--).
2018-12-13 12:24:38,5, GSM1: Modem handler 0 has started. PID: 50667.
2018-12-13 12:24:38,5, GSM1: Using check_memory_method 1: CPMS is used.
2018-12-13 12:24:38,5, smsd: Outgoing file checker has started. PID: 80713.
2018-12-13 12:24:38,7, smsd: All PID's: 80713,50667
2018-12-13 12:24:38,6, GSM1: Checking device for incoming SMS
2018-12-13 12:24:38,6, GSM1: Checking if modem is ready
2018-12-13 12:24:39,7, GSM1: -&gt; AT
2018-12-13 12:24:39,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:39,7, GSM1: &lt;- OK
2018-12-13 12:24:39,6, GSM1: Pre-initializing modem
2018-12-13 12:24:39,7, GSM1: -&gt; ATE0
2018-12-13 12:24:39,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:39,7, GSM1: &lt;- OK                                                                                                                                                                
2018-12-13 12:24:39,7, GSM1: -&gt; AT+CMEE=1;+CREG=2
2018-12-13 12:24:40,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:40,7, GSM1: &lt;- OK
2018-12-13 12:24:40,6, GSM1: Checking if modem needs PIN
2018-12-13 12:24:40,7, GSM1: -&gt; AT+CPIN?
2018-12-13 12:24:40,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:40,7, GSM1: &lt;- +CPIN: READY OK
2018-12-13 12:24:40,6, GSM1: Initializing modem
2018-12-13 12:24:40,7, GSM1: -&gt; AT^CURC=0
2018-12-13 12:24:41,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:41,7, GSM1: &lt;- OK
2018-12-13 12:24:41,7, GSM1: -&gt; AT+CSQ
2018-12-13 12:24:41,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:41,7, GSM1: &lt;- +CSQ: 22,99 OK
2018-12-13 12:24:41,6, GSM1: Signal Strength Indicator: (22,99) -69 dBm (Excellent), Bit Error Rate: not known or not detectable                                                                  
2018-12-13 12:24:41,6, GSM1: Checking if Modem is registered to the network
2018-12-13 12:24:41,7, GSM1: -&gt; AT+CREG?
2018-12-13 12:24:42,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:42,7, GSM1: &lt;- +CREG: 2,5,"792D","04947221" OK
2018-12-13 12:24:42,6, GSM1: Modem is registered to a roaming partner network
2018-12-13 12:24:42,6, GSM1: Location area code: 792D, Cell ID: 7221
2018-12-13 12:24:42,7, GSM1: -&gt; AT+CSQ
2018-12-13 12:24:42,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:42,7, GSM1: &lt;- +CSQ: 21,99 OK
2018-12-13 12:24:42,6, GSM1: Signal Strength Indicator: (21,99) -71 dBm (Excellent), Bit Error Rate: not known or not detectable                                                                  
2018-12-13 12:24:42,6, GSM1: Selecting PDU mode
2018-12-13 12:24:42,7, GSM1: -&gt; AT+CMGF=0
2018-12-13 12:24:42,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:42,7, GSM1: &lt;- OK
2018-12-13 12:24:43,7, GSM1: -&gt; AT+CGSN
2018-12-13 12:24:43,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:43,7, GSM1: &lt;- 866785033700732 OK                                                                                                                                        [26/2614]
2018-12-13 12:24:43,5, GSM1: IMEI: 866785033700732
2018-12-13 12:24:43,7, GSM1: -&gt; AT+CIMI
2018-12-13 12:24:43,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:43,7, GSM1: &lt;- 520050314388175 OK
2018-12-13 12:24:43,5, GSM1: IMSI: 520050314388175
2018-12-13 12:24:43,6, GSM1: Checking if reading of messages is supported
2018-12-13 12:24:43,7, GSM1: -&gt; AT+CPMS?
2018-12-13 12:24:44,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:44,7, GSM1: &lt;- +CPMS: "ME",0,20,"ME",0,20,"ME",0,20 OK
2018-12-13 12:24:44,6, GSM1: Checking memory size
2018-12-13 12:24:44,7, GSM1: -&gt; AT+CPMS?
2018-12-13 12:24:44,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:44,7, GSM1: &lt;- +CPMS: "ME",0,20,"ME",0,20,"ME",0,20 OK
2018-12-13 12:24:44,6, GSM1: Used memory is 0 of 20
2018-12-13 12:24:44,6, GSM1: No SMS received
2018-12-13 12:24:54,6, GSM1: Checking device for incoming SMS
2018-12-13 12:24:54,6, GSM1: Checking if modem is ready
2018-12-13 12:24:54,7, GSM1: -&gt; AT
2018-12-13 12:24:55,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:55,7, GSM1: &lt;- OK
2018-12-13 12:24:55,6, GSM1: Pre-initializing modem
2018-12-13 12:24:55,7, GSM1: -&gt; ATE0
2018-12-13 12:24:55,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:55,7, GSM1: &lt;- OK
2018-12-13 12:24:55,7, GSM1: -&gt; AT+CMEE=1;+CREG=2
2018-12-13 12:24:56,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:56,7, GSM1: &lt;- OK
2018-12-13 12:24:56,6, GSM1: Initializing modem
2018-12-13 12:24:56,7, GSM1: -&gt; AT^CURC=0
2018-12-13 12:24:56,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:56,7, GSM1: &lt;- OK
2018-12-13 12:24:56,7, GSM1: -&gt; AT+CSQ
2018-12-13 12:24:57,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:57,7, GSM1: &lt;- +CSQ: 21,99 OK
2018-12-13 12:24:57,6, GSM1: Signal Strength Indicator: (21,99) -71 dBm (Excellent), Bit Error Rate: not known or not detectable                                                                  
2018-12-13 12:24:57,6, GSM1: Checking if Modem is registered to the network
2018-12-13 12:24:57,7, GSM1: -&gt; AT+CREG?
2018-12-13 12:24:57,7, GSM1: Command is sent, waiting for the answer. (10)
2018-12-13 12:24:57,7, GSM1: &lt;- +CREG: 2,5,"792D","04947221" OK
2018-12-13 12:24:57,6, GSM1: Modem is registered to a roaming partner network
2018-12-13 12:24:57,6, GSM1: Selecting PDU mode
2018-12-13 12:24:57,7, GSM1: -&gt; AT+CMGF=0
2018-12-13 12:24:57,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:57,7, GSM1: &lt;- OK
2018-12-13 12:24:57,6, GSM1: Checking memory size
2018-12-13 12:24:58,7, GSM1: -&gt; AT+CPMS?
2018-12-13 12:24:58,7, GSM1: Command is sent, waiting for the answer. (5)
2018-12-13 12:24:58,7, GSM1: &lt;- +CPMS: "ME",0,20,"ME",0,20,"ME",0,20 OK
2018-12-13 12:24:58,6, GSM1: Used memory is 0 of 20
2018-12-13 12:24:58,6, GSM1: No SMS received
</code></pre>
<p>and continues to poll</p>
<p>Now, we need to set up pppd. Assuming that no received activation SMS is due to not registering on the data network yet, so leaving smsd running and will attempt the ppd setup</p>
<p>Much talk is had about HiLink mode vs Stick mode.</p>
<p>I decided to figure out what mine was being detected as:</p>
<pre><code>obsd# usbdevs
Controller /dev/usb0:
addr 01: 8086:0000 Intel, xHCI root hub
addr 02: 12d1:1442 HUAWEI_MOBILE, HUAWEI_MOBILE
addr 03: 05ac:12aa Apple Inc., iPod
Controller /dev/usb1:
addr 01: 8086:0000 Intel, EHCI root hub
addr 02: 8087:8000 Intel, Rate Matching Hub
addr 03: 04f3:012d ELAN, Touchscreen
addr 04: 04ca:7036 SC20A38485AA4C8E3D, Integrated Camera
</code></pre>
<p>Based on the above, it looks like we’re already operating in Stick mode, with <code>12d1:1442</code>, else assuming the support in umsm in OpenBSD for this device is handling the USB modeswitching automagically…</p>
<p>Setting up the pppd stuff</p>
<p>I have</p>
<p>/etc/ppp/peers/e3372:</p>
<pre><code>cuaU0
115200
debug
noauth
nocrtscts
:10.254.254.1
ipcp-accept-remote
defaultroute
user isp@cingulargprs.com
demand
active-filter 'not udp port 123'
persist
idle 600
connect "/usr/sbin/chat -v -f /etc/ppp/dtac-chat"

</code></pre>
<p>/etc/ppp/dtac-chat:</p>
<pre><code>TIMEOUT 10
REPORT CONNECT
ABORT BUSY
ABORT 'NO CARRIER'
ABORT ERROR
'' ATZ OK AT&amp;F OK
AT+CGDCONT=1,"IP","www.dtac.co.th" OK
ATD*99***1# CONNECT

</code></pre>
<p>/etc/ppp/chap-secrets</p>
<pre><code># Secrets for authentication using CHAP
# client        server  secret                  IP addresses
isp@cingulargprs.com    *       CINGULAR1

</code></pre>
<p>Finally, run</p>
<p><code>ifconfig ppp0 create</code> (should be showing in ifconfig now) and then</p>
<p><code>pppd e3372 call</code></p>
<p>This doesn’t give me much, so I tail <code>/var/log/daemon</code>, resulting in:</p>
<pre><code>Dec 13 13:09:29 obsd pppd[80914]: pppd 2.3.5 started by leon, uid 0
Dec 13 13:09:29 obsd pppd[80914]: ioctl(TIOCSETD): Device not configured

</code></pre>
<p>A clue, when I try to manually talk to the modem, <code>cu -s 115200 -l cuaU0</code>, I get device is busy. So I stop the smsd daemon and try again:</p>
<p>This time, it connects, but nothing is given back…whereas previously, I think I was able to type commands over the serial connection…</p>
<p>To isolate the cause, I duplicated the peers/e3372 file with another with just these lines</p>
<p>/etc/ppp/peers/dummytest</p>
<pre><code>cuaU0
115200
debug
</code></pre>
<p>which got me one more line in the output:</p>
<pre><code>Dec 13 13:40:24 obsd pppd[46299]: pppd 2.3.5 started by leon, uid 0
Dec 13 13:40:27 obsd pppd[46299]: Serial connection established.
Dec 13 13:40:28 obsd pppd[46299]: ioctl(TIOCSETD): Device not configured
</code></pre>
<p>I’m also seeing the device being disconnected at hangup and then re-detected:</p>
<pre><code>Dec 13 13:40:32 obsd /bsd: ucom0 detached
Dec 13 13:40:32 obsd /bsd: umsm0 detached
Dec 13 13:40:32 obsd /bsd: umsm1 detached
Dec 13 13:40:39 obsd /bsd: umsm0 at uhub0 port 2 configuration 1 interface 0 "HUAWEI_MOBILE HUAWEI_MOBILE" rev 2.10/1.02 addr 2                                                                   
Dec 13 13:40:39 obsd /bsd: umsm0 detached
Dec 13 13:40:39 obsd /bsd: umsm0 at uhub0 port 2 configuration 1 interface 0 "HUAWEI_MOBILE HUAWEI_MOBILE" rev 2.10/1.02 addr 2                                                                   
Dec 13 13:40:39 obsd /bsd: ucom0 at umsm0
Dec 13 13:40:39 obsd /bsd: umsm1 at uhub0 port 2 configuration 1 interface 1 "HUAWEI_MOBILE HUAWEI_MOBILE" rev 2.10/1.02 addr 2
</code></pre>
<p>So will continue adjusting that file or the ones it links to and see if we get any more output…</p>
<p>Trying <code>cu</code> again, allowed some commands to come back from the modem, but no input was accepted:</p>
<pre><code>obsd# cu -s 115200 -l cuaU0
Connected to /dev/cuaU0 (speed 115200)

^RSSI:20

^HCSQ:"LTE",48,35,86,14

^RSSI:1

^HCSQ:"LTE",11,0,96,0

+CGREG: 5,"792D","04947221"

+CREG: 5,"792D","04947221"

^RSSI:20

^HCSQ:"LTE",48,37,91,18

^RSSI:20

^HCSQ:"LTE",48,36,91,16

^RSSI:21

^HCSQ:"LTE",50,36,86,14

....


^HCSQ:"LTE",54,41,111,16

^RSSI:1

^HCSQ:"LTE",11,0,106,0

+CGREG: 5,"007C","00B19502"

+CREG: 5,"007C","00B19502"

^RSSI:25

^HCSQ:"LTE",58,47,116,14

+CGREG: 1,"007C","00B19502"

+CREG: 1,"007C","00B19502"

^XLEMA:1,2,112,0,1,fff

^XLEMA:2,2,911,0,1,fff

^NWTIME:18/12/13,06:20:04+28,00


^EONS:0

+CGREG: 1,"792D","04947220"

+CREG: 1,"792D","04947220"

^RSSI:20

^HCSQ:"LTE",48,39,71,22

+CGREG: 5,"792D","04947220"

+CREG: 5,"792D","04947220"

^XLEMA:1,2,112,0,1,fff

^XLEMA:2,2,911,0,1,fff

^NWTIME:18/12/13,06:20:08+28,00


^EONS:0

</code></pre>
<p>This would appear that it’s getting real messages from the network.</p>
<p>About to reboot, then try under Ubuntu live CD. Then try to get to the bottom of the</p>
<blockquote><p>ioctl(TIOCSETD): Device not configured</p></blockquote>
<p>Looking at <a href="https://gist.github.com/artizirk/20acc2ab07fe6cad9fcc">https://gist.github.com/artizirk/20acc2ab07fe6cad9fcc</a></p>
<p>Will install <code>socat</code> and try sending some AT commands to get a better picture</p>
<p><code>socat - /dev/cuaU0</code></p>
<pre><code>ATI
Manufacturer: huawei

Model: E3372

Revision: 22.329.63.00.74

IMEI: 866785033700732

+GCAP: +CGSM,+DS,+ES



OK

AT + CSQ


+CSQ: 20,99
# signal strength (over 19 is excellent)



AT ^ CARDLOCK?


^CARDLOCK: 2,10,0

# shows modem is enabled

AT ^ FHVER


^FHVER:"E3372H-607 22.329.63.00.74,CL2E3372HM Ver.A"

AT ^ VERSION?


^VERSION:BDT:Apr 08 2018, 12:13:47

^VERSION:EXTS:22.329.63.00.74

^VERSION:INTS:

^VERSION:EXTD:WEBUI_17.100.20.02.74_HILINK

^VERSION:INTD:

^VERSION:EXTH:CL2E3372HM Ver.A

^VERSION:INTH:

^VERSION:EXTU:E3372

^VERSION:INTU:

^VERSION:CFG:1004

^VERSION:PRL:

^VERSION:OEM:

^VERSION:INI:



OK

</code></pre>
<p>Finally, booted up an Ubuntu live image, which did the switchmode to “HiLink”, adding a new device to ifconfig</p>
<p>This modified the device, as then booting back into OpenBSD, we have the cdce0 ethernet device showing. Adding a simple <code>/etc/hostname.cdce0</code> with <code>dhcp up</code> and a <code>sh /etc/netstart/</code> and we’re all good.</p>
]]></content:encoded>
			</item>
		<item>
		<title>Getting Snipcart custom data attributes into WordPress + Elementor Pricing Table</title>
		<link>https://ljs.dev/getting-snipcart-custom-data-attributes-into-wordpress-elementor-pricing-table/</link>
		<pubDate>Sat, 24 Nov 2018 16:02:29 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Dev Notes]]></category>

		<guid isPermaLink="false">https://ljs.dev/?p=462</guid>
		<description><![CDATA[After shunning pagebuilders in WordPress long enough, I gave Elementor a try for a landing page layout and found it quite useful. I also realized how terribly far behind Gutenberg is! So, Elementor got me 90% of the way there, as is often the case in WordPress &#8211; simple, until it isn’t! Custom code in &#8230; <p class="link-more"><a href="https://ljs.dev/getting-snipcart-custom-data-attributes-into-wordpress-elementor-pricing-table/" class="more-link">Continue reading<span class="screen-reader-text"> "Getting Snipcart custom data attributes into WordPress + Elementor Pricing Table"</span></a></p>]]></description>
				<content:encoded><![CDATA[<p>After shunning pagebuilders in WordPress long enough, I gave Elementor a try for a landing page layout and found it quite useful. I also realized how terribly far behind Gutenberg is!</p>
<p>So, Elementor got me 90% of the way there, as is often the case in WordPress &#8211; simple, until it isn’t!</p>
<p>Custom code in the theme’s <code>functions.php</code> got the last piece of the puzzle:</p>
<pre><code class="language-php">function wp2static_snipcart_callback($buffer) {
   $html_output = $buffer;

   $dom = new DOMDocument();
   $dom-&gt;loadHTML($html_output);

   $finder = new DomXPath($dom);
   $classname="elementor-price-table__button";
   $nodes = $finder-&gt;query("//*[contains(@class, '$classname')]");

   $yearly_buy_button = $nodes-&gt;item(1);

   $yearly_buy_button-&gt;setAttribute('class','elementor-price-table__button elementor-button elementor-size-md snipcart-add-item');                                                                
   $yearly_buy_button-&gt;setAttribute('data-item-name','PowerPack, unlimited sites, yearly');
   $yearly_buy_button-&gt;setAttribute('data-item-id','powerpack-unlimited-yearly');
   $yearly_buy_button-&gt;setAttribute('data-item-url','https://securityandperformance.com/');
   $yearly_buy_button-&gt;setAttribute('data-item-price','99.00');
   $yearly_buy_button-&gt;setAttribute('data-item-payment-interval','Year');
   $yearly_buy_button-&gt;setAttribute('data-item-payment-interval-count','1');

   $unlimited_buy_button = $nodes-&gt;item(2);

   $unlimited_buy_button-&gt;setAttribute('class','elementor-price-table__button elementor-button elementor-size-md snipcart-add-item');                                                             
   $unlimited_buy_button-&gt;setAttribute('data-item-name','PowerPack, unlimited sites, lifetime');
   $unlimited_buy_button-&gt;setAttribute('data-item-id','powerpack-unlimited-lifetime');
   $unlimited_buy_button-&gt;setAttribute('data-item-url','https://securityandperformance.com/');
   $unlimited_buy_button-&gt;setAttribute('data-item-price','299.00');

   return $dom-&gt;saveHTML();
}

add_filter( 'the_content', 'wp2static_snipcart_callback' );

// duplicate with wp_styles for loaded CSS in frontend
function insite_inspect_scripts() {
global $wp_scripts; echo PHP_EOL.’’.PHP_EOL;
}

add_action( ‘wp_print_scripts’, ‘insite_inspect_scripts’ );
</code></pre>
]]></content:encoded>
			</item>
		<item>
		<title>Low footprint tech hub</title>
		<link>https://ljs.dev/low-footprint-tech-hub/</link>
		<pubDate>Mon, 12 Nov 2018 16:13:18 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Dev Notes]]></category>

		<guid isPermaLink="false">https://ljs.dev/?p=465</guid>
		<description><![CDATA[Aiming to create very low-cost, low-footprint self-contained workstations that can be deployed to areas lacking resources. A place you go to invest in knowledge and develop skills “The Knowledge Bank Network” Functions: knowledge bank offline WikiPedia, StackOverflow entertainment public domain movies, music, books, games communications share one connection Ideas to explore: raspberryPi control unit, acting &#8230; <p class="link-more"><a href="https://ljs.dev/low-footprint-tech-hub/" class="more-link">Continue reading<span class="screen-reader-text"> "Low footprint tech hub"</span></a></p>]]></description>
				<content:encoded><![CDATA[<p>Aiming to create very low-cost, low-footprint self-contained workstations that can be deployed to areas lacking resources.</p>
<p>A place you go to invest in knowledge and develop skills</p>
<p>“The Knowledge Bank Network”</p>
<p>Functions:</p>
<ul>
<li>knowledge bank
<ul>
<li>offline WikiPedia, StackOverflow</li>
</ul>
</li>
<li>entertainment
<ul>
<li>public domain movies, music, books, games</li>
</ul>
</li>
<li>communications
<ul>
<li>share one connection</li>
</ul>
</li>
</ul>
<p>Ideas to explore:</p>
<p>raspberryPi control unit, acting as router, NAS &#8211; OpenBSD &#8211; dhcp &#8211; pf to share connection &#8211; local web server &#8211; shows network status &#8211; portal to documentation</p>
<p>10 / 100 witches &#8211; should be an abundance &#8211; how much power do they consume?</p>
<ul>
<li>solar panels</li>
<li>inverter</li>
</ul>
<p>Lowest possible power consumption target to minimize amount of solar/wind required</p>
]]></content:encoded>
			</item>
		<item>
		<title>Keep Your Core Strong &#8211; Know Your BSD/Linux Tools</title>
		<link>https://ljs.dev/keep-your-core-strong-know-your-bsd-linux-tools/</link>
		<pubDate>Wed, 07 Nov 2018 16:14:31 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Dev Notes]]></category>

		<guid isPermaLink="false">https://ljs.dev/?p=467</guid>
		<description><![CDATA[Just as the sage advice from The Pragmatic Programmer on mastering one text editor makes so much sense for those of us whose majority of work is rearranging bits on the digital titanic, the same holds true for knowing your operating system and investing in solid tooling for your other main productive tasks. Opinionated preface &#8230; <p class="link-more"><a href="https://ljs.dev/keep-your-core-strong-know-your-bsd-linux-tools/" class="more-link">Continue reading<span class="screen-reader-text"> "Keep Your Core Strong &#8211; Know Your BSD/Linux Tools"</span></a></p>]]></description>
				<content:encoded><![CDATA[<p>Just as the sage advice from <a href="https://pragprog.com/book/tpp/the-pragmatic-programmer">The Pragmatic Programmer</a> on mastering one text editor makes so much sense for those of us whose majority of work is rearranging bits on the digital titanic, the same holds true for knowing your operating system and investing in solid tooling for your other main productive tasks.</p>
<h3 id="opinionated-preface-open-source-or-gtfo">Opinionated preface &#8211; Open source or GTFO</h3>
<p>The world’s resources are quickly depleting. A growing population having to work sh!tty jobs for sh!tty companies selling sh!tty stuff is not sustainable and kinda hard to keep respecting yourself as a highly paid developer building yet another duplicated piece of software on VC funds.</p>
<p>If the aim is to advance humanity and avoid depleting all the resources as population explodes, then we should be looking to re-use and not create uneccessarily. Open source software that’s been continually refined since the 60’s/70’s is continually being optimized and is able to run well on older hardware.</p>
<p>We don’t need another One Laptop Per Child venture creating future ewaste when we already have an abundance of capable hardware. Let’s stop making batteries full of costly/harful chemicals and get more solar to continue running old laptops after their batteries have died.</p>
<h3 id="on-with-the-show-the-core-utilities-i-invest-in-learning-well">On with the show &#8211; the core utilities I invest in learning well</h3>
<p>This page serves a purpose to me as storing minimal configuration notes. I strive to not become dependent on too much customisation for the reasons:</p>
<ul>
<li>portability: the benefit of these tools are their ubiquitousness, I want the ability to grab any available device and quickly be productive without a day of setup or requiring of internet to pull down convoluted dotfiles libraries</li>
<li>learn the tool well: you may be working around the original design of the software. If it’s really not there, consider contributing it to the project, or if it doesn’t belong there, look for another modular program to handle that responsibility</li>
</ul>
<h4 id="openbsd">OpenBSD</h4>
<p>Slow is smooth and smooth is fast. Forgoing the bells, whistles and kitchen sink included in most Linux distros, OpenBSD has been planned with security and quality in mind. You’re not forced to read the docs, but you’ll soon realize it’s the most efficient path forward.</p>
<p>Amazing support for older architectures and a great welcoming community.</p>
<h3 id="japanese-support">Japanese support</h3>
<p>Install relevant fcitx packages</p>
<p>Install <code>ja-sazanami-ttf</code></p>
<p>edit <code>$HOME/.config/fcitx/profile</code>, changing <code>anthy:False</code> to <code>anthy:True</code></p>
<p>set shortcut key in <code>$HOME/.config/fcitx/config</code></p>
<p>set XMODIFIERS in .xsession, along with fcitx-autostart before cwm</p>
<p>xset fontpath</p>
<h3 id="vim">Vim</h3>
<p>My minimal .vimrc</p>
<pre><code class="language-vimscript">set ts=2 sw=2 expandtab ruler nu noswapfile colorcolumn=80                      
syntax on                                                                       
colorscheme delek                                                               
                                                                                
autocmd Filetype php setlocal expandtab tabstop=4 shiftwidth=4 softtabstop=4       
autocmd Filetype js setlocal expandtab tabstop=2 shiftwidth=2 softtabstop=2        
                                                                                
highlight ExtraWhitespace ctermbg=red guibg=red                                 
match ExtraWhitespace /\s\+$/   

" newly acquired skills
set wildmenu " show search reuslts and such as popups
set path+=** " set path to this folder and all subdirs, ie for searching

</code></pre>
<h3 id="git">git</h3>
<p>My minimal .gitconfig</p>
<pre><code>
</code></pre>
<h3 id="tmux">tmux</h3>
<p>My minimal .tmux.conf</p>
<pre><code># moving between panes
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# large history limit
set -g history-limit 999999999
</code></pre>
<h3 id="httpd">httpd</h3>
<p>Ensure you have required files from /etc in /var/www/etc chroot (copy all when lazy)</p>
<h1 id="httpd-conf">httpd.conf</h1>
<p>basic example</p>
<pre><code>prefork 10

types { include "/usr/share/misc/mime.types" }

server "localhost" {
	listen on * port 80

	directory index "index.php"

	root "/htdocs"

	location "/*.css*" {
		request no rewrite
	}

	location "/*.js*" {
		request no rewrite
	}

	location "/*.png*" {
		request no rewrite
	}

	location "/mystaticsite*" {
		directory index "index.html"
		request no rewrite
	}

	location "/*.php*" {
		fastcgi socket "/run/php-fpm.sock"
	}

	location "/posts*" {
		fastcgi socket "/run/php-fpm.sock"
	}
}
</code></pre>
<h1 id="php-conf">PHP conf</h1>
<p>As per <a href="https://dev.to/nabbisen/fixing-php72fpm-on-openbsd-64-f0f">https://dev.to/nabbisen/fixing-php72fpm-on-openbsd-64-f0f</a>, we need to manually create the missing pool file in /etc/php-fpm.d/somefile.conf</p>
<pre><code>; Start a new pool named 'www'.
[www]

; specify user
user = www
group = www
listen.owner = www
listen.group = www
listen.mode = 0660

chroot = /var/www

listen = /var/www/run/php-fpm.sock

; allow php execution on any URL
security.limit_extensions = 

; endpoint to monitor PHP FPM
pm.status_path = /status

; define process manager
pm = dynamic
pm.max_children = 9
pm.max_spare_servers = 4
pm.min_spare_servers = 2
pm.start_servers = 3

; help pinpoint slow scripts
slowlog = /var/log/php-slow.log
request_slowlog_timeout = 2s
</code></pre>
<h1 id="maria">maria</h1>
<p>install server and client packages</p>
<p>run <code>mysql_install_db</code></p>
<p>reload and run <code>mysql_secure_installation</code></p>
<p>create a non-root user</p>
<p>connect via 127.0.0.1 vs localhost in WP config</p>
<h1 id="wp">WP</h1>
<h1 id="file-permissions">file permissions</h1>
<p>TODO: currently 777’ing locally to allow watch script</p>
<pre><code>find /var/www/htdocs -type d -exec chmod 775 {} \;
find /var/www/htdocs -type f -exec chmod 755 {} \;
chmod 400 /var/www/htdocs/wp-config.php
</code></pre>
<h1 id="watch-files">watch files</h1>
<p>watch_me_sync.sh</p>
<pre><code>#!/bin/sh                                                                       
while :                                                                         
do                                                                              
    find $HOME/wordpress-static-html-plugin/ -type f ! -path '*/.*' |           
    entr -d  sh $HOME/deploy_changed_file.sh /_                                 
done 
</code></pre>
<h1 id="doas">doas</h1>
<pre><code># run WP-CLI from same user as hitting from web
permit persist MYUSERNAME as www cmd wp
</code></pre>
<p>deploy_changes_file.sh</p>
<pre><code>#!/bin/sh                                                                       
                                                                                
CHANGED_FILE=$1                                                                 
PROJECT_DIR=$HOME/wordpress-static-html-plugin/                                 
BASENAME=${CHANGED_FILE#"$PROJECT_DIR"}                                         
TARGET_PATH=/var/www/htdocs/wp-content/plugins/wordpress-static-html-plugin/${CHANGED_FILE#"$PROJECT_DIR"}
TARGET_PATH2=/var/www/htdocs/securesite.local/wp-content/plugins/wordpress-static-html-plugin/${CHANGED_FILE#"$PROJECT_DIR"}
TARGET_PATH3=/var/www/htdocs/subdirsite.local/wordpress/wp-content/plugins/wordpress-static-html-plugin/${CHANGED_FILE#"$PROJECT_DIR"}
TARGET_PATH4=/var/www/htdocs/japanesesite.local/wp-content/plugins/wordpress-static-html-plugin/${CHANGED_FILE#"$PROJECT_DIR"}
                                                                                
echo "$BASENAME"                                                                
                                                                                
cp $CHANGED_FILE $TARGET_PATH                                                   
cp $CHANGED_FILE $TARGET_PATH2                                                  
cp $CHANGED_FILE $TARGET_PATH3                                                  
cp $CHANGED_FILE $TARGET_PATH4                                                  
                                                                                
echo '' 
</code></pre>
<h3 id="coreutils">coreutils</h3>
<p>Refer to the excellent man pages provided by OpenBSD or take a chance with the docs from whatever other OS you’re using.</p>
<p>My minimal shell profile (bash by default)</p>
<pre><code># enable viewing media offline
function dla {                                                                  
    # dl searched song to mp3                                                   
    youtube-dl --extract-audio --no-mtime --audio-format mp3 --no-playlist --default-search ytsearch -o "~/Music/%(title)s.%(ext)s" "$*" 
    if [ $? -eq 0 ]; then                                                       
      # send newest file to smplayer playlist                                   
      LATEST_FILE=$(ls -t *.mp3 | head -1)                                      
      smplayer -add-to-playlist "$LATEST_FILE"                                  
    else                                                                        
        echo "failed to download"                                               
    fi                                                                          
} 

# usage
dla some title with spaces no need to surround with quotes
</code></pre>
<p>&nbsp;</p>
]]></content:encoded>
			</item>
		<item>
		<title>Tweaking the Bitnami WordPress Stack on AWS LightSail</title>
		<link>https://ljs.dev/tweaking-the-bitnami-wordpress-stack-on-aws-lightsail/</link>
		<pubDate>Wed, 17 Oct 2018 16:16:44 +0000</pubDate>
		<dc:creator><![CDATA[admin]]></dc:creator>
				<category><![CDATA[Dev Notes]]></category>

		<guid isPermaLink="false">https://ljs.dev/?p=469</guid>
		<description><![CDATA[Update: I no longer use Bitnami on AWS LightSail due to the steps required to get sane application behaviour and performance are not worth it. Leaving this up for any searches leading here and will recommend for a similar level of serviced hosting, try DigitalOcean or Vultr. Tired of clunkily updating a GitHub gist, herein &#8230; <p class="link-more"><a href="https://ljs.dev/tweaking-the-bitnami-wordpress-stack-on-aws-lightsail/" class="more-link">Continue reading<span class="screen-reader-text"> "Tweaking the Bitnami WordPress Stack on AWS LightSail"</span></a></p>]]></description>
				<content:encoded><![CDATA[<p><strong>Update:</strong></p>
<p>I no longer use Bitnami on AWS LightSail due to the steps required to get sane application behaviour and performance are not worth it. Leaving this up for any searches leading here and will recommend for a similar level of serviced hosting, try <a href="https://digitalocean.com">DigitalOcean</a> or <a href="https://vultr.com">Vultr</a>.</p>
<p>Tired of clunkily updating a GitHub gist, herein lie my notes used when provisioning an AWS LightSail instance with Bitnami WordPress for quick migration/debugging of an existing user’s WordPress site.</p>
<ul>
<li>copy public key via the virtual terminal in AWS Console</li>
<li>set a DNS entry to point dev domain to the instance’s IP</li>
<li>access site at dev domain</li>
<li>rm bitnami banner
<ul>
<li><code>sudo /opt/bitnami/apps/wordpress/bnconfig --disable_banner 1</code></li>
<li><code>sudo /opt/bitnami/ctlscript.sh restart apache</code></li>
</ul>
</li>
<li>SSH in using dev domain</li>
<li><a href="https://metablogue.com/enable-lets-encrypt-ssl-aws-lightsail/">enable SSL</a>
<ul>
<li><code>sudo mkdir /opt/bitnami/letsencrypt</code></li>
<li><code>cd /opt/bitnami/letsencrypt</code></li>
<li><code>sudo wget https://dl.eff.org/certbot-auto</code></li>
<li><code>sudo chmod a+x ./certbot-auto</code></li>
<li><code>sudo ./certbot-auto</code></li>
<li><code>sudo ./certbot-auto certonly --webroot -w /opt/bitnami/apps/wordpress/htdocs/ -d example.com</code></li>
<li><code>sudo ln -s /etc/letsencrypt/live/[DOMAIN]/fullchain.pem /opt/bitnami/apache2/conf/server.crt</code></li>
<li><code>sudo ln -s /etc/letsencrypt/live/[DOMAIN]/privkey.pem /opt/bitnami/apache2/conf/server.key</code></li>
<li>Make sure that the certificate file name and path is correct. If you receive an error that file already exists, use the below command to rename the files:</li>
<li><code>mv /opt/bitnami/apache2/conf/server.key /opt/bitnami/apache2/conf/serverkey.old</code></li>
<li><code>mv /opt/bitnami/apache2/conf/server.crt /opt/bitnami/apache2/conf/servercrt.old</code></li>
<li><code>sudo /opt/bitnami/ctlscript.sh restart apache</code></li>
</ul>
</li>
<li>adjust wp-config to use https
<ul>
<li><code>sed -i 's/http/https/' /opt/bitnami/apps/wordpress/htdocs/wp-config.php</code></li>
<li><code>sudo chown -R bitnami:daemon /opt/bitnami/apps/wordpress/htdocs/</code></li>
</ul>
</li>
<li>force https in top of file: <code>/opt/bitnami/apps/wordpress/conf/httpd-prefix.conf</code>
<ul>
<li><code>RewriteEngine On</code></li>
<li><code>RewriteCond %{HTTPS} !=on</code></li>
<li><code>RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [R,L]</code></li>
</ul>
</li>
<li>Restart server to enforce https
<ul>
<li><code>sudo /opt/bitnami/ctlscript.sh restart apache</code></li>
</ul>
</li>
<li>backup wp-config somewhere
<ul>
<li><code>sudo cp /opt/bitnami/apps/wordpress/htdocs/wp-config.php /opt/bitnami/apps/wordpress/wp-config-backup-randstring.php</code></li>
</ul>
</li>
<li>disable mod pagespeed
<ul>
<li><code>sudo vim /opt/bitnami/apache2/conf/pagespeed.conf</code></li>
<li><code>ModPagespeed on</code> &gt; <code>ModPagespeed off</code></li>
<li><code>sudo /opt/bitnami/ctlscript.sh restart apache</code></li>
</ul>
</li>
<li>copy existing site’s files into WP dir</li>
<li>backup existing wp-config
<ul>
<li><code>sudo cp /opt/bitnami/apps/wordpress/htdocs/wp-config.php<br />
/opt/bitnami/apps/wordpress/user-original-wp-config-backup-randstring.php</code></li>
</ul>
</li>
<li>restore Bitnami’s wp-config</li>
<li>copy any custom <code>define</code>’s or code from existing wp-config</li>
<li>import users DB
<ul>
<li>delete bitnami_wordpress</li>
<li>create bitnami_wordpress</li>
<li>import .sql</li>
</ul>
</li>
<li>rewrite any hard links within DB
<ul>
<li><code>sudo wp --allow-root search-replace 'OLD.domain.com' 'NEW.wp2static.com'</code></li>
</ul>
</li>
<li>change admin user email and pwd
<ul>
<li><code>sudo wp --allow-root user update 1 --user_pass="PASSWORD"</code></li>
</ul>
</li>
<li>rewrite any hard links within site (optional, careful of mailto links, etc)
<ul>
<li><code>find -name '*.css' -exec sed -i 's/OLD.domain.com/NEW.wp2static.com/g' {} +</code></li>
</ul>
</li>
<li>reset file permissions
<ul>
<li><code>sudo chown -R bitnami:daemon /opt/bitnami/apps/wordpress/htdocs/</code></li>
<li><code>sudo find /opt/bitnami/apps/wordpress/htdocs/ -type f -exec chmod 664 {} \;</code></li>
<li><code>sudo find /opt/bitnami/apps/wordpress/htdocs/ -type d -exec chmod 775 {} \;</code></li>
<li>also php-fpm restart <code>sudo /opt/bitnami/ctlscript.sh restart php-fpm</code></li>
</ul>
</li>
<li>enable debugging</li>
</ul>
<p><code>define( 'WP_DEBUG', true );</code></p>
<p><strong>tailing WP logs</strong></p>
<p><code>tail -f /opt/bitnami/apache2/logs/error_log</code></p>
<p><strong>connect to db</strong></p>
<p><code>mysql -u bn_wordpress -p bitnami_wordpress # and pwd from wp-config</code></p>
<p><strong>check plugin options</strong></p>
<p><code>select * from wp_options where option_name = 'wp-static-html-output-options' \G;</code></p>
<ul>
<li><code>working_directory</code> option can persist the old sever’s paths</li>
</ul>
<p><strong>modify PHP ini</strong></p>
<h1 id="not-yet-needed-seems-to-have-large-max-execution-time-already">not yet needed, seems to have large <code>max_execution_time</code> already</h1>
<ul>
<li>disable opcache</li>
<li>disable mod pagespeed</li>
<li>use development level error logging</li>
<li>increase memory</li>
<li>extend max execution time</li>
</ul>
<p><code>sudo vim opt/bitnami/php/etc/php.ini</code></p>
<p><strong>Basic Auth</strong></p>
<p><a href="https://docs.bitnami.com/google/apps/wordpress-multisite/administration/use-htpasswd/">https://docs.bitnami.com/google/apps/wordpress-multisite/administration/use-htpasswd/</a></p>
<p><strong>less noisy error log</strong></p>
<p><code>sudo echo 'ErrorLogFormat "\n \"%M\" \n  "' &gt;&gt; /opt/bitnami/apache2/conf/httpd.conf</code></p>
<p>^ needed re-rediting to affect the CR’s, look to fix</p>
<h4 id="scratch-notes">Scratch notes</h4>
<ul>
<li>deal with <code>(70007) The timeout specified has expired</code> errors from <code>proxy_fcgi:error</code>:</li>
</ul>
<p><a href="https://stackoverflow.com/a/38711063/1668057">https://stackoverflow.com/a/38711063/1668057</a></p>
<p><code>Timeout 900</code> -&gt;</p>
<p>in <code>/opt/bitnami/apache2/conf/httpd.conf</code></p>
<p><a href="https://medium.com/@sbuckpesch/apache2-and-php-fpm-performance-optimization-step-by-step-guide-1bfecf161534">https://medium.com/@sbuckpesch/apache2-and-php-fpm-performance-optimization-step-by-step-guide-1bfecf161534</a></p>
<p><strong>import vim and tmux confs</strong></p>
<p><code>curl<br />
https://gist.githubusercontent.com/leonstafford/6891b76aeaf43766dd52676d6bed1b08/raw/9979e28a9abf07af94b505d35ff9a4eb3da7cb9f/.tmux.conf<br />
--output ~/.tmux.conf</code></p>
<p><code>curl<br />
https://gist.githubusercontent.com/leonstafford/39333da3399adee7e88cb869b4685dff/raw/5e6e7b7fb834d996763da3d358d949d309691350/.vimrc<br />
--output ~/.vimrc</code></p>
<p>not working without additional domain verification overrides: &#8211; enable mail sending (consider Amazon has a limit for LightSail) not verified, erros with &#8211; <code>sudo apt install sendmail</code> &#8211; <code>sudo vim opt/bitnami/php/etc/php.ini</code> &#8211; uncomment <code>sendmail_path = "env -i /usr/sbin/sendmail -t -i"</code> &#8211; <code>sudo /opt/bitnami/ctlscript.sh restart apache</code></p>
]]></content:encoded>
			</item>
	</channel>
</rss>
